# Codebase Structure

**Analysis Date:** 2026-02-02

## Directory Layout

```
arbstr/
├── src/                    # Rust source code
│   ├── main.rs            # CLI entry point (serve, check, providers commands)
│   ├── lib.rs             # Library root, module exports
│   ├── config.rs          # Configuration parsing and validation
│   ├── error.rs           # Error types with OpenAI-compatible responses
│   ├── proxy/             # HTTP proxy server and request handling
│   │   ├── mod.rs         # Module declaration and re-exports
│   │   ├── server.rs      # axum server setup, AppState, router creation
│   │   ├── handlers.rs    # HTTP endpoint handlers (chat/completions, models, health, providers)
│   │   └── types.rs       # OpenAI-compatible request/response types
│   └── router/            # Provider selection logic
│       ├── mod.rs         # Module declaration and re-exports
│       └── selector.rs    # Provider filtering, policy matching, cost-based selection
├── Cargo.toml             # Rust package manifest and dependencies
├── config.example.toml    # Example configuration file
├── README.md              # Project overview and quickstart
├── CLAUDE.md              # Development guide for Claude
├── LICENSE                # MIT license
├── .gitignore             # Git ignore patterns
└── .planning/             # Planning documents (generated by GSD tools)
    └── codebase/          # Codebase analysis documents
        └── STRUCTURE.md   # This file
```

## Directory Purposes

**src/:**
- Purpose: All Rust source code for the arbstr binary and library
- Contains: Main entry point, core logic modules, types
- Key files: `main.rs` (CLI), `lib.rs` (module root)

**src/proxy/:**
- Purpose: HTTP server implementation and request/response handling
- Contains: axum endpoint handlers, OpenAI-compatible types, server setup
- Key files:
  - `server.rs`: Server initialization and AppState definition
  - `handlers.rs`: `/v1/chat/completions`, `/v1/models`, `/health`, `/providers` endpoints
  - `types.rs`: ChatCompletionRequest, ChatCompletionResponse, Message, etc.

**src/router/:**
- Purpose: Provider selection logic and policy constraint matching
- Contains: Router struct, SelectedProvider, provider filtering algorithms
- Key files: `selector.rs` with Router::select() core logic

**.planning/codebase/:**
- Purpose: Generated analysis documents for GSD orchestrator and executor
- Contains: ARCHITECTURE.md, STRUCTURE.md, CONVENTIONS.md, TESTING.md, STACK.md, INTEGRATIONS.md, CONCERNS.md
- Not committed initially; created by GSD tools

## Key File Locations

**Entry Points:**
- `src/main.rs`: CLI entry point (lines 1-194); parses subcommands (serve, check, providers)
- `src/proxy/handlers.rs` line 19: `chat_completions()` handler for POST /v1/chat/completions
- `src/proxy/server.rs` line 38: `run_server()` function initializes and starts HTTP server

**Configuration:**
- `config.example.toml`: Full example with all options documented
- `src/config.rs`: Config structs (ServerConfig, ProviderConfig, PolicyRule, DatabaseConfig)
- `.env` or `ARBSTR_CONFIG` env var: Runtime config file path (default: `./config.toml`)

**Core Logic:**
- `src/router/selector.rs`: Router::select() (lines 52-100) implements provider selection
- `src/router/selector.rs` lines 102-128: find_policy() implements policy matching by header and keywords
- `src/router/selector.rs` lines 130-167: apply_policy_constraints() filters by allowed models and max cost
- `src/proxy/handlers.rs` lines 19-129: chat_completions() orchestrates request forwarding

**Testing:**
- `src/config.rs` lines 195-249: Config parsing tests
- `src/router/selector.rs` lines 185-246: Router selection and policy matching tests
- Unit tests embedded in module files (no separate `tests/` directory yet)

## Naming Conventions

**Files:**
- Snake_case: `config.rs`, `selector.rs`, `server.rs`, `handlers.rs`, `main.rs`
- Module files: `mod.rs` for module declaration
- Examples: `src/proxy/mod.rs`, `src/router/mod.rs`

**Directories:**
- Snake_case: `proxy/`, `router/`, `src/`, `.planning/`
- Functional grouping: Feature-based (proxy = HTTP layer, router = selection logic)

**Rust Types:**
- PascalCase for structs: `AppState`, `ChatCompletionRequest`, `Router`, `SelectedProvider`, `ProviderConfig`
- PascalCase for enums: `Commands`, `Error`, `StopSequence`
- SCREAMING_SNAKE_CASE for constants: `ARBSTR_POLICY_HEADER`

**Functions:**
- Snake_case: `run_server()`, `chat_completions()`, `select_cheapest()`, `apply_policy_constraints()`
- Handler pattern: `{resource}_{action}()` e.g., `chat_completions()`, `list_models()`, `health()`

**Variables:**
- Snake_case: `listen_addr`, `upstream_request`, `policy_name`, `http_client`
- Descriptive names preferred: `provider_router` not `pr`; `user_prompt` not `p`

## Where to Add New Code

**New Feature (e.g., request logging, new strategy):**
- Primary code: `src/router/selector.rs` for routing logic or `src/proxy/handlers.rs` for request processing
- Tests: Add tests in the same file using `#[cfg(test)] mod tests { ... }`
- Configuration: Add new fields to relevant config struct in `src/config.rs`

**New Endpoint:**
- Implementation: Add handler function in `src/proxy/handlers.rs`
- Route: Register in `src/proxy/server.rs` in `create_router()` function (lines 25-36)
- Types: Add request/response types to `src/proxy/types.rs` if needed

**New Provider Selection Strategy:**
- Implementation: Add match arm in `Router::select()` (lines 90-95 in `src/router/selector.rs`)
- Helpers: Add new private method in Router impl block for the strategy logic
- Config: Add strategy name to `PolicyRule` or `PoliciesConfig` options

**Utilities/Helpers:**
- Shared helpers: Create as functions in appropriate module file
- Parser/type helpers: Add to `src/proxy/types.rs` (already has `ChatCompletionRequest::user_prompt()`)
- Config helpers: Add methods to config structs in `src/config.rs`

## Special Directories

**src/proxy/:**
- Purpose: Contains all HTTP-specific code
- Generated: No generated files
- Committed: Yes, all files committed

**src/router/:**
- Purpose: Contains all provider selection logic
- Generated: No generated files
- Committed: Yes, all files committed

**.planning/codebase/:**
- Purpose: Generated analysis documents for GSD tools
- Generated: Yes, created by GSD orchestrator
- Committed: No, typically in .gitignore during development

## File Dependencies

**Dependency chain (simplified):**
```
main.rs
  → lib.rs (re-exports)
    → config.rs (configuration parsing)
    → error.rs (error types)
    → proxy/ (HTTP server)
      → server.rs (uses Router, Config)
      → handlers.rs (uses Router, Config, request types)
      → types.rs (OpenAI types)
    → router/ (provider selection)
      → selector.rs (uses ProviderConfig, PolicyRule)
```

**Module visibility:**
- `lib.rs` re-exports public items: `Config`, `Error`, `Result`, `proxy::run_server`, `router::Router`, `router::SelectedProvider`
- `main.rs` imports from `arbstr` crate (same as external consumers)
- Internal modules marked `mod` not `pub mod` are private to their parent

---

*Structure analysis: 2026-02-02*
