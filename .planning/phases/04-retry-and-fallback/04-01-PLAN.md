---
phase: 04-retry-and-fallback
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/router/selector.rs
  - src/router/mod.rs
autonomous: true

must_haves:
  truths:
    - "Router can return an ordered list of candidate providers for a given model, not just the top pick"
    - "Candidates are sorted cheapest-first by routing cost (output_rate + base_fee)"
    - "Candidates are deduplicated by provider name (same provider listed twice only appears once)"
    - "Existing select() still works and returns the cheapest single provider"
  artifacts:
    - path: "src/router/selector.rs"
      provides: "select_candidates() method on Router"
      exports: ["select_candidates"]
      contains: "fn select_candidates"
    - path: "src/router/mod.rs"
      provides: "Re-export of select_candidates via Router"
  key_links:
    - from: "Router::select"
      to: "Router::select_candidates"
      via: "select() delegates to select_candidates().remove(0)"
      pattern: "select_candidates.*remove\\(0\\)"
---

<objective>
Add a `select_candidates` method to the Router that returns a `Vec<SelectedProvider>` sorted by cost (cheapest first), deduplicated by provider name. Refactor existing `select()` to delegate to it.

Purpose: The retry/fallback module (Plan 02) needs an ordered candidate list to pick the fallback provider. This plan provides that API without changing any behavior.
Output: `Router::select_candidates()` method, existing `select()` refactored to delegate, unit tests.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-retry-and-fallback/04-CONTEXT.md
@.planning/phases/04-retry-and-fallback/04-RESEARCH.md
@src/router/selector.rs
@src/router/mod.rs
@src/config.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add select_candidates and refactor select</name>
  <files>src/router/selector.rs, src/router/mod.rs</files>
  <action>
Add a public method `select_candidates` to `Router` in `src/router/selector.rs`:

```rust
pub fn select_candidates(
    &self,
    model: &str,
    policy_name: Option<&str>,
    prompt: Option<&str>,
) -> Result<Vec<SelectedProvider>>
```

Implementation:
1. Find matching policy via `self.find_policy(policy_name, prompt)` (reuse existing private method)
2. Filter providers by model support (same logic as current `select`)
3. Return `Error::NoProviders` if no candidates
4. Apply policy constraints if policy found (reuse `apply_policy_constraints`)
5. Sort candidates by routing cost: `output_rate + base_fee` ascending (cheapest first)
6. Deduplicate by provider name using a `HashSet<String>` -- keep first occurrence (cheapest) for each name. Use `std::collections::HashSet`.
7. Return `Error::NoPolicyMatch` if empty after dedup
8. Map to `Vec<SelectedProvider>` via `.map(SelectedProvider::from)`

Refactor existing `select()` to delegate:
```rust
pub fn select(&self, model: &str, policy_name: Option<&str>, prompt: Option<&str>) -> Result<SelectedProvider> {
    self.select_candidates(model, policy_name, prompt)
        .map(|mut v| v.remove(0))
}
```

This preserves exact existing behavior (select returns cheapest single provider).

In `src/router/mod.rs`, no changes needed -- `Router` is already re-exported and `select_candidates` is a method on it.

Add unit tests in the existing `#[cfg(test)] mod tests` block in selector.rs:

1. `test_select_candidates_returns_ordered_list` -- With 3 providers offering "gpt-4o" at different costs, verify candidates returned in cheapest-first order.

2. `test_select_candidates_deduplicates_by_name` -- Two providers with same name but different rates, verify only one appears in result.

3. `test_select_delegates_to_candidates` -- Verify `select()` returns the same provider as `select_candidates()[0]`.

4. `test_select_candidates_filters_by_model` -- Provider that doesn't offer the model is excluded.

5. `test_select_candidates_empty_returns_error` -- Model with no providers returns `Error::NoProviders`.
  </action>
  <verify>
Run `cargo test --lib router` -- all existing and new tests pass.
Run `cargo clippy -- -D warnings` -- no warnings.
  </verify>
  <done>
`select_candidates()` returns ordered, deduplicated `Vec<SelectedProvider>` for a model. Existing `select()` delegates to it and all prior tests still pass. Five new unit tests pass.
  </done>
</task>

</tasks>

<verification>
- `cargo test` -- all tests pass (existing + new)
- `cargo clippy -- -D warnings` -- clean
- `cargo build` -- compiles without errors
</verification>

<success_criteria>
- Router has `select_candidates()` returning `Vec<SelectedProvider>` sorted cheapest-first
- Candidates deduplicated by provider name
- `select()` delegates to `select_candidates()` with identical behavior to before
- All existing routing tests pass unchanged
- Five new unit tests for `select_candidates` pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-retry-and-fallback/04-01-SUMMARY.md`
</output>
