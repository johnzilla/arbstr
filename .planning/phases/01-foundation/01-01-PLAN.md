---
phase: 01-foundation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/router/selector.rs
autonomous: true

must_haves:
  truths:
    - "select_cheapest ranks providers by output_rate + base_fee, not output_rate alone"
    - "actual_cost_sats returns correct f64 using the full formula with real token counts"
    - "All existing routing tests pass without modification (no regressions)"
    - "A provider with lower output_rate but higher base_fee can lose to a provider with higher output_rate but zero base_fee"
  artifacts:
    - path: "src/router/selector.rs"
      provides: "Updated select_cheapest ranking and new actual_cost_sats function"
      contains: "actual_cost_sats"
  key_links:
    - from: "select_cheapest"
      to: "ProviderConfig"
      via: "output_rate + base_fee ranking key"
      pattern: "output_rate.*\\+.*base_fee|base_fee.*\\+.*output_rate"
---

<objective>
Fix the routing cost ranking to include base_fee and add an actual cost calculation function for post-response logging.

Purpose: The current `select_cheapest` uses only `output_rate` to rank providers, ignoring `base_fee`. This means a provider with a high base_fee but low output_rate could be incorrectly chosen as cheapest. Additionally, no function exists to compute actual cost from real token counts -- this is needed by Phase 2 for logging.

Output: Updated `select_cheapest` method and new public `actual_cost_sats` function in `src/router/selector.rs`, both with tests.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/router/selector.rs
@src/config.rs
</context>

<feature>
  <name>Cost calculation: routing heuristic and actual cost</name>
  <files>src/router/selector.rs</files>
  <behavior>
    Routing heuristic (select_cheapest):
    - Ranks candidates by `output_rate + base_fee` (ascending)
    - Case 1: cheap(output_rate=15, base_fee=0) vs expensive(output_rate=30, base_fee=1) -> selects "cheap" (15 < 31)
    - Case 2: low-rate-high-fee(output_rate=10, base_fee=8) vs high-rate-no-fee(output_rate=15, base_fee=0) -> selects "high-rate-no-fee" (15 < 18)
    - Case 3: tied routing cost -> either is acceptable (min_by_key picks first)

    Actual cost function (actual_cost_sats):
    - Formula: (input_tokens * input_rate + output_tokens * output_rate) / 1000.0 + base_fee
    - All inputs are integers (u32 for tokens, u64 for rates), output is f64
    - Case 1: actual_cost_sats(100, 200, 10, 30, 1) = (100*10 + 200*30)/1000.0 + 1 = 8.0
    - Case 2: actual_cost_sats(10, 5, 5, 15, 0) = (10*5 + 5*15)/1000.0 + 0 = 0.125
    - Case 3: actual_cost_sats(0, 0, 10, 30, 5) = 0/1000.0 + 5 = 5.0 (base_fee only)
    - Case 4: actual_cost_sats(1000, 1000, 10, 30, 0) = (10000 + 30000)/1000.0 + 0 = 40.0
  </behavior>
  <implementation>
    1. RED: Write failing tests first:
       - `test_base_fee_affects_cheapest_selection`: Two providers where base_fee changes the ranking (the one with lower output_rate+base_fee wins). Use the Case 2 data from behavior above.
       - `test_actual_cost_calculation`: Test the 4 cases above using assert with f64::EPSILON tolerance.
       - `test_actual_cost_fractional_sats`: Verify sub-sat precision is preserved (case 2 returns 0.125, not 0).
       Run `cargo test` -- these must fail (actual_cost_sats doesn't exist yet, and test_base_fee should fail because current code only uses output_rate).

    2. GREEN: Make tests pass:
       - Change `select_cheapest` min_by_key from `p.output_rate` to `p.output_rate + p.base_fee`
       - Update the doc comment on `select_cheapest` from "by output rate" to "by output_rate + base_fee"
       - Add a new public function `actual_cost_sats(input_tokens: u32, output_tokens: u32, input_rate: u64, output_rate: u64, base_fee: u64) -> f64` that implements the full formula
       - Cast to f64 BEFORE division to avoid integer truncation
       Run `cargo test` -- all tests must pass including existing ones.

    3. REFACTOR: No refactoring expected -- the changes are minimal.
  </implementation>
</feature>

<verification>
```bash
# All tests pass (including existing ones)
cargo test

# Specific new tests pass
cargo test test_base_fee_affects_cheapest_selection
cargo test test_actual_cost_calculation
cargo test test_actual_cost_fractional_sats

# No compiler warnings
cargo clippy -- -D warnings

# actual_cost_sats function exists and is public
grep -n "pub fn actual_cost_sats" src/router/selector.rs
```
</verification>

<success_criteria>
- `select_cheapest` uses `output_rate + base_fee` as ranking key
- `actual_cost_sats` function exists, is public, returns f64
- All 5 existing tests + 3 new tests pass
- `cargo clippy` produces no warnings
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
