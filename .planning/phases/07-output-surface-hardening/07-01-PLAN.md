---
phase: 07-output-surface-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/config.rs
  - src/main.rs
  - src/proxy/handlers.rs
autonomous: true

must_haves:
  truths:
    - "Starting arbstr with a config.toml that has 0644 permissions emits a warning naming the file and showing '0644'"
    - "The /providers endpoint returns masked key prefixes like 'cashuA...***' instead of '[REDACTED]'"
    - "The providers CLI command shows masked key prefixes for each provider that has a key"
    - "Starting arbstr with a provider whose api_key is a plaintext literal emits a warning recommending environment variables"
    - "The check command also emits a warning for plaintext literal keys"
    - "Keys shorter than 10 characters return '[REDACTED]' instead of a masked prefix"
    - "Mock mode does not emit plaintext key warnings (key_sources is empty)"
  artifacts:
    - path: "src/config.rs"
      provides: "check_file_permissions() function and ApiKey::masked_prefix() method"
      contains: "fn check_file_permissions"
    - path: "src/config.rs"
      provides: "ApiKey::masked_prefix() returning prefix + '...***'"
      contains: "fn masked_prefix"
    - path: "src/main.rs"
      provides: "RED-01 file permission warning, RED-04 literal key warning, masked prefix in providers CLI"
      contains: "check_file_permissions"
    - path: "src/proxy/handlers.rs"
      provides: "masked_prefix() call in list_providers handler"
      contains: "masked_prefix()"
  key_links:
    - from: "src/main.rs"
      to: "src/config.rs"
      via: "check_file_permissions() call in serve and check commands"
      pattern: "check_file_permissions"
    - from: "src/proxy/handlers.rs"
      to: "src/config.rs"
      via: "ApiKey::masked_prefix() call in list_providers"
      pattern: "masked_prefix"
    - from: "src/main.rs"
      to: "src/config.rs"
      via: "convention_env_var_name() in RED-04 warning message"
      pattern: "convention_env_var_name"
---

<objective>
Implement file permission warnings, masked key prefix display, and plaintext literal key warnings across all output surfaces.

Purpose: Complete the v1.1 Secrets Hardening milestone by auditing and hardening all remaining output surfaces -- users get actionable warnings about config hygiene and can verify key identity without seeing full keys.

Output: Updated `src/config.rs` with `check_file_permissions()` and `ApiKey::masked_prefix()`, updated `src/main.rs` with startup warnings and CLI masked prefixes, updated `src/proxy/handlers.rs` with masked prefix in `/providers` endpoint.
</objective>

<execution_context>
@/home/john/.claude/get-shit-done/workflows/execute-plan.md
@/home/john/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-output-surface-hardening/07-RESEARCH.md
@src/config.rs
@src/main.rs
@src/proxy/handlers.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add check_file_permissions and masked_prefix to config.rs</name>
  <files>src/config.rs</files>
  <action>
Add two new capabilities to `src/config.rs`:

**1. `check_file_permissions()` function (RED-01):**

Add a public function with `#[cfg(unix)]` and `#[cfg(not(unix))]` variants:

```rust
/// Check if a config file has permissions more permissive than 0600.
///
/// Returns `Some((path_display, mode))` if overly permissive, `None` if OK.
/// On non-Unix platforms, always returns `None`.
#[cfg(unix)]
pub fn check_file_permissions(path: &std::path::Path) -> Option<(String, u32)> {
    use std::os::unix::fs::PermissionsExt;
    let metadata = std::fs::metadata(path).ok()?;
    let mode = metadata.permissions().mode() & 0o777;
    if mode & 0o177 != 0 {
        Some((path.display().to_string(), mode))
    } else {
        None
    }
}

#[cfg(not(unix))]
pub fn check_file_permissions(_path: &std::path::Path) -> Option<(String, u32)> {
    None
}
```

Key details:
- `& 0o777` strips file type bits from mode
- `& 0o177` checks for any bits beyond owner read/write (0o600). This correctly allows both 0o600 and 0o400.
- Returns `Option` so caller controls warning format
- `.ok()?` silently skips if metadata can't be read

**2. `ApiKey::masked_prefix()` method (RED-03):**

Add to the existing `impl ApiKey` block:

```rust
/// Return a masked representation showing a recognizable prefix.
///
/// Format: first 6 characters + "...***" for keys >= 10 chars.
/// For keys shorter than 10 characters, returns "[REDACTED]" to avoid
/// revealing a significant portion.
pub fn masked_prefix(&self) -> String {
    let secret = self.expose_secret();
    if secret.len() < 10 {
        return "[REDACTED]".to_string();
    }
    format!("{}...***", &secret[..6])
}
```

Key details:
- 6-character prefix identifies "cashuA" tokens without revealing content
- Keys < 10 chars fall back to "[REDACTED]" to avoid exposing most of a short key
- Uses `expose_secret()` -- remains grep-auditable
- Separate from Debug/Display/Serialize which continue to emit "[REDACTED]"

**3. Unit tests:**

Add these tests to the existing `#[cfg(test)] mod tests` block in `config.rs`:

```rust
#[test]
fn test_masked_prefix_normal_key() {
    let key = ApiKey::from("cashuAbcdefghijklmnop");
    assert_eq!(key.masked_prefix(), "cashuA...***");
}

#[test]
fn test_masked_prefix_short_key_redacted() {
    let key = ApiKey::from("short");
    assert_eq!(key.masked_prefix(), "[REDACTED]");
}

#[test]
fn test_masked_prefix_boundary_key() {
    let key = ApiKey::from("1234567890"); // exactly 10 chars
    assert_eq!(key.masked_prefix(), "123456...***");
}

#[test]
fn test_masked_prefix_does_not_expose_full_key() {
    let key = ApiKey::from("cashuABCD1234secrettoken");
    let masked = key.masked_prefix();
    assert!(masked.contains("cashuA"));
    assert!(!masked.contains("secrettoken"));
    assert!(masked.ends_with("...***"));
}

#[cfg(unix)]
#[test]
fn test_check_permissions_too_open() {
    use std::os::unix::fs::PermissionsExt;
    let dir = tempfile::tempdir().unwrap();
    let path = dir.path().join("test-config.toml");
    std::fs::write(&path, "[server]\nlisten = \"127.0.0.1:8080\"").unwrap();
    std::fs::set_permissions(&path, std::fs::Permissions::from_mode(0o644)).unwrap();
    let result = check_file_permissions(&path);
    assert!(result.is_some(), "0644 should trigger warning");
    let (_, mode) = result.unwrap();
    assert_eq!(mode, 0o644);
}

#[cfg(unix)]
#[test]
fn test_check_permissions_correct() {
    use std::os::unix::fs::PermissionsExt;
    let dir = tempfile::tempdir().unwrap();
    let path = dir.path().join("test-config.toml");
    std::fs::write(&path, "[server]\nlisten = \"127.0.0.1:8080\"").unwrap();
    std::fs::set_permissions(&path, std::fs::Permissions::from_mode(0o600)).unwrap();
    let result = check_file_permissions(&path);
    assert!(result.is_none(), "0600 should not trigger warning");
}

#[cfg(unix)]
#[test]
fn test_check_permissions_read_only_ok() {
    use std::os::unix::fs::PermissionsExt;
    let dir = tempfile::tempdir().unwrap();
    let path = dir.path().join("test-config.toml");
    std::fs::write(&path, "[server]\nlisten = \"127.0.0.1:8080\"").unwrap();
    std::fs::set_permissions(&path, std::fs::Permissions::from_mode(0o400)).unwrap();
    let result = check_file_permissions(&path);
    assert!(result.is_none(), "0400 should not trigger warning");
}
```
  </action>
  <verify>Run `cargo test --lib -- test_masked_prefix test_check_permissions` -- all new tests pass. Run `cargo clippy -- -D warnings` -- no warnings.</verify>
  <done>ApiKey::masked_prefix() returns "cashuA...***" for normal keys, "[REDACTED]" for short keys. check_file_permissions() detects 0644 but not 0600 or 0400. All tests pass, clippy clean.</done>
</task>

<task type="auto">
  <name>Task 2: Wire warnings and masked prefix into CLI commands and /providers endpoint</name>
  <files>src/main.rs, src/proxy/handlers.rs</files>
  <action>
**1. Update `src/main.rs` -- Serve command (RED-01 + RED-04):**

In the `Commands::Serve` match arm, after config loading (line ~80, after `Config::from_file_with_env(&config_path)?`) but before the "Configuration loaded" info log:

Add RED-01 file permission check (only in non-mock mode, since mock doesn't load a file):
```rust
// RED-01: Warn if config file permissions are too open
if let Some((path, mode)) = arbstr::config::check_file_permissions(std::path::Path::new(&config_path)) {
    tracing::warn!(
        file = %path,
        permissions = format_args!("{:04o}", mode),
        "Config file has permissions more open than 0600. Consider: chmod 600 {}",
        path
    );
}
```

Place this right after the `Config::from_file_with_env` call, inside the `else` branch (non-mock). The mock branch skips this because there is no config file to check.

Update the key source logging loop to add RED-04 literal key warning. Replace the existing `KeySource::Literal` arm:
```rust
KeySource::Literal => {
    tracing::info!(provider = %provider_name, "key from config-literal");
    tracing::warn!(
        provider = %provider_name,
        "Plaintext API key in config file. Consider using environment variables: \
         set {} or use api_key = \"${{{}}}\"",
        arbstr::config::convention_env_var_name(provider_name),
        arbstr::config::convention_env_var_name(provider_name)
    );
}
```

**2. Update `src/main.rs` -- Check command (RED-01 + RED-04):**

In the `Commands::Check` match arm, after `"Configuration is valid!"` println:

Add RED-01 permission check using println (check command uses println, not tracing):
```rust
// RED-01: Check config file permissions
if let Some((path, mode)) = arbstr::config::check_file_permissions(std::path::Path::new(&config_path)) {
    println!();
    println!("  WARNING: Config file '{}' has permissions {:04o} (more open than 0600)", path, mode);
    println!("  Consider: chmod 600 {}", path);
}
```

Update the `KeySource::Literal` arm in the check command's key source loop to add RED-04 warning:
```rust
KeySource::Literal => {
    let conv_var = arbstr::config::convention_env_var_name(name);
    println!("  {}: key from config-literal", name);
    println!("    WARNING: Plaintext key. Consider: set {} or use api_key = \"${{{}}}\"", conv_var, conv_var);
}
```

**3. Update `src/main.rs` -- Providers command (RED-03):**

In the `Commands::Providers` match arm, add masked key display after the rates println and before the empty `println!()`:
```rust
if let Some(ref api_key) = provider.api_key {
    println!("    Key: {}", api_key.masked_prefix());
}
```

Insert this between the `base_fee` conditional println and the final `println!()` separator.

**4. Update `src/proxy/handlers.rs` -- /providers endpoint (RED-03):**

In the `list_providers` function, replace:
```rust
"api_key": if p.api_key.is_some() {
    serde_json::Value::String("[REDACTED]".to_string())
} else {
    serde_json::Value::Null
},
```

With:
```rust
"api_key": match &p.api_key {
    Some(key) => serde_json::Value::String(key.masked_prefix()),
    None => serde_json::Value::Null,
},
```

This changes the output from a uniform `"[REDACTED]"` to distinguishable masked prefixes like `"cashuA...***"`.
  </action>
  <verify>Run `cargo build` -- compiles without errors. Run `cargo test` -- all existing and new tests pass. Run `cargo clippy -- -D warnings` -- no warnings. Manually verify: `cargo run -- serve --mock` starts without any plaintext key warnings (mock mode returns empty key_sources). Verify: `cargo run -- providers -c config.example.toml` shows masked key prefixes (or "[REDACTED]" for short keys).</verify>
  <done>Serve command warns on 0644+ config file permissions and warns on literal plaintext keys with actionable env var suggestion. Check command shows same warnings with println. Providers CLI and /providers endpoint show masked key prefixes. Mock mode produces no spurious warnings.</done>
</task>

</tasks>

<verification>
1. `cargo test` -- all tests pass (existing + new masked_prefix + permission check tests)
2. `cargo clippy -- -D warnings` -- no warnings
3. `cargo build --release` -- compiles cleanly
4. Manual: create a config file with `chmod 644`, run `cargo run -- serve -c config.toml` and verify the permission warning appears in output with octal format
5. Manual: set a literal api_key in config, run serve and verify the plaintext key warning appears with the convention env var suggestion
6. Manual: run `cargo run -- check -c config.toml` and verify both permission and literal key warnings appear
7. Manual: run `cargo run -- providers -c config.toml` and verify masked key prefixes (not "[REDACTED]")
8. Manual: `curl http://localhost:8080/providers` returns `"api_key": "cashuA...***"` style values
9. Manual: `cargo run -- serve --mock` does NOT emit plaintext key warnings
</verification>

<success_criteria>
- RED-01: Config files with permissions > 0600 trigger a warning naming the file and showing octal permissions
- RED-03: /providers endpoint and providers CLI show masked key prefixes (e.g., "cashuA...***") instead of "[REDACTED]"
- RED-04: Literal plaintext api_key values in config trigger a warning recommending environment variables with the specific convention var name
- All existing tests pass with no regressions
- No new crate dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/07-output-surface-hardening/07-01-SUMMARY.md`
</output>
