# Requirements Archive: v1.4 Circuit Breaker

**Archived:** 2026-02-16
**Status:** SHIPPED

For current requirements, see `.planning/REQUIREMENTS.md`.

---

# Requirements: arbstr

**Defined:** 2026-02-16
**Core Value:** Smart model selection that minimizes sats spent per request without sacrificing quality

## v1.4 Requirements

Requirements for circuit breaker milestone. Each maps to roadmap phases.

### Circuit Breaker

- [ ] **CB-01**: Each provider has an independent circuit breaker with 3 states (Closed, Open, Half-Open)
- [ ] **CB-02**: Circuit opens after 3 consecutive request failures (5xx/timeout only, not 4xx)
- [ ] **CB-03**: Successful request resets the consecutive failure counter to zero
- [ ] **CB-04**: After 30s in Open state, circuit transitions to Half-Open for probe
- [ ] **CB-05**: Half-Open allows exactly one probe request (single-permit model)
- [ ] **CB-06**: Probe success closes circuit; probe failure reopens with timer reset

### Routing

- [ ] **RTG-01**: Router skips providers with open circuits during candidate selection
- [ ] **RTG-02**: When all providers for a model have open circuits, return 503 fail-fast
- [ ] **RTG-03**: Non-streaming handler records success/failure outcomes to circuit breaker after retry
- [ ] **RTG-04**: Streaming handler records outcomes in spawned background task after stream completes

### Health

- [ ] **HLT-01**: GET /health returns per-provider circuit state (closed/open/half_open) and failure count
- [ ] **HLT-02**: Top-level status degrades: ok (all closed) → degraded (some open) → unhealthy (all open)

## Future Requirements

Deferred to future release. Tracked but not in current roadmap.

### Circuit Breaker Config

- **CBC-01**: Configurable failure_threshold in config.toml (default 3)
- **CBC-02**: Configurable recovery_timeout_secs in config.toml (default 30)
- **CBC-03**: Per-provider threshold overrides

### Observability

- **OBS-01**: State change logging (tracing::warn on Open, tracing::info on recovery)
- **OBS-02**: Circuit state in response headers (x-arbstr-circuit-state)
- **OBS-03**: Open-since and recovery-at timestamps in /health response
- **OBS-04**: Circuit state in /v1/stats response

## Out of Scope

Explicitly excluded. Documented to prevent scope creep.

| Feature | Reason |
|---------|--------|
| Sliding window failure rate | Overkill for local proxy with 1-10 providers and low traffic |
| Active health probing (periodic pings) | Consumes provider API quota, LLM providers lack health endpoints |
| Adaptive/ML-based threshold tuning | Overengineering for local proxy |
| Request queuing/replay when circuit opens | LLM requests not meaningfully replayable |
| Per-model circuit breakers | LLM failures are infrastructure-level, not model-specific |
| Global circuit breaker | Would block healthy providers when only one is down |
| Distributed/shared circuit state | Single-process local proxy, in-memory is correct |
| Exponential backoff on recovery timeout | Fixed 30s is sufficient, can add later if needed |

## Traceability

Which phases cover which requirements. Updated during roadmap creation.

| Requirement | Phase | Status |
|-------------|-------|--------|
| CB-01 | Phase 13 | Pending |
| CB-02 | Phase 13 | Pending |
| CB-03 | Phase 13 | Pending |
| CB-04 | Phase 13 | Pending |
| CB-05 | Phase 13 | Pending |
| CB-06 | Phase 13 | Pending |
| RTG-01 | Phase 14 | Pending |
| RTG-02 | Phase 14 | Pending |
| RTG-03 | Phase 14 | Pending |
| RTG-04 | Phase 14 | Pending |
| HLT-01 | Phase 15 | Pending |
| HLT-02 | Phase 15 | Pending |

**Coverage:**
- v1.4 requirements: 12 total
- Mapped to phases: 12
- Unmapped: 0

---
*Requirements defined: 2026-02-16*
*Last updated: 2026-02-16 after roadmap creation*
